# Backup service Dockerfile for Odoo 17 Production

FROM postgres:13-alpine

# Install required packages
RUN apk add --no-cache \
    bash \
    curl \
    gzip \
    tar \
    aws-cli \
    python3 \
    py3-pip \
    tzdata \
    dos2unix

# Set timezone
ENV TZ=Asia/Bangkok
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Create backup user and directories
RUN addgroup -g 1000 backup && \
    adduser -D -u 1000 -G backup backup

RUN mkdir -p /backup /scripts /var/log/backup

# Copy backup scripts (as root first)
COPY scripts/backup.sh /scripts/backup.sh
COPY scripts/restore.sh /scripts/restore.sh

# Verify scripts exist, fix line endings, and make them executable
RUN echo "=== Checking copied scripts ===" && \
    ls -la /scripts/ && \
    echo "=== Converting line endings ===" && \
    dos2unix /scripts/*.sh 2>/dev/null || true && \
    echo "=== Making scripts executable ===" && \
    chmod +x /scripts/*.sh && \
    echo "=== Validating scripts ===" && \
    ls -la /scripts/ && \
    head -1 /scripts/backup.sh && \
    echo "=== Setting ownership ===" && \
    chown -R backup:backup /backup /scripts /var/log/backup && \
    echo "=== Final validation ===" && \
    ls -la /scripts/ && \
    echo "=== Backup script setup completed ==="

# Switch to backup user
USER backup

# Set working directory
WORKDIR /backup

# Set entrypoint to run backup script
ENTRYPOINT ["/scripts/backup.sh"]